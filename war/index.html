<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <link rel="stylesheet" href="/stylesheets/theme/jquery-ui-1.8.7.css" type="text/css"/>
  <link rel="stylesheet" href="/stylesheets/worktime.css" type="text/css">
  <script type="text/javascript" src="/javascripts/jquery-1.4.4.min.js"></script>
  <script type="text/javascript" src="/javascripts/jquery-ui-1.8.7.custom.min.js"></script>
  <script type="text/javascript" src="/javascripts/jquery-ui-i18n.js"></script>
  <script type="text/javascript" src="/javascripts/worktime.js"></script>
  <title>作業時間記録</title>
</head>
<body>
  <script type="text/javascript">
var dialog = null;
$(function() {

	$(".date_chooser").datepicker();
	$("#search_button").click(function() {
	    if (dialog == null) {
	        var loading = $("<div>検索中...</div>").dialog({
	            modal: true,
	            draggable: false,
	            resizable: false,
	            title: "Information",
	            closeOnEscape: false
	        });
        }
		$.ajax({
			dataType: "json",
            type: "POST",
            data: {
                    from: $(".search input[name=from]").val(),
                    to: $(".search input[name=to]").val(),
            },
            cache: false,
            url: "/worktime/json",
            success: function(data, status, request) {
                function pad(value) {
                    return (value.toString().length < 2) ? '0' + value : value;
                }
                function createCell(value) {
                    var date_cell = $("<td></td>");
                }
                function createInput(type, clazz) {
                    var input = $("<input></input>");
                    input.attr("type", type);
                    input.addClass(clazz);
                    return input;
                }
                $(".list > table tr.detail").empty().remove();
                for (i = 0; i < data.length; i++) {
                    v = data[i];
                    var row = $("<tr></tr>");
                    row.addClass("detail");
                    // 日付
                    var date_input = createInput("text", "date_chooser date");
                    if (v.date != undefined) {
                        var dt = new Date(v.date);
                        date_input.attr("value", dt.getUTCFullYear() + "/" + pad(dt.getUTCMonth() + 1) + "/" + pad(dt.getUTCDate()));
                    }
                    row.append($("<td></td>").addClass("date").append(date_input));
                    // 開始
                    var from_input = createInput("text", "from");
                    if (v.from != undefined) {
                        var dt = new Date(v.from);
                        from_input.attr("value", pad(dt.getUTCHours()) + ":" + pad(dt.getUTCMinutes()));
                    }
                    row.append($("<td></td>").addClass("from").append(from_input));
                    // 終了
                    var to_input = createInput("text", "to");
                    if (v.to != undefined) {
                        var dt = new Date(v.to);
                        to_input.attr("value", pad(dt.getUTCHours()) + ":" + pad(dt.getUTCMinutes()));
                    }
                    row.append($("<td></td>").addClass("to").append(to_input));
                    // コード
                    var code_input = createInput("text", "code");
                    if (v.code != undefined) {
                        code_input.attr("value", $("<div>").html(v.code).html());
                    }
                    row.append($("<td></td>").addClass("code").append(code_input));
                    // コード
                    var work_input = createInput("text", "work");
                    if (v.work != undefined) {
                        work_input.attr("value", $("<div>").html(v.work).html());
                    }
                    row.append($("<td></td>").addClass("work").append(work_input));
                    // 備考
                    var remark_input = createInput("text", "remark");
                    if (v.remark != undefined) {
                        remark_input.attr("value", $("<div>").html(v.remark).html());
                    }
                    row.append($("<td></td>").addClass("remark").append(remark_input));
                    // 操作
                    var control_cell = $("<td></td>");
                    control_cell.addClass("control");
                    if (v.key != undefined) {
                        // key
                        var key_input = createInput("hidden", "control");
                        key_input.attr("value", $("<div>").html(v.key).html());
                        control_cell.append(key_input);
                        // 削除ボタン
                        var delete_button = createInput("button", "ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only");
                        delete_button.attr("value", "削除");
                        delete_button.attr("onclick", "del(this); return false;");
                        control_cell.append(delete_button);
                        // 更新ボタン
                        var update_button = createInput("button", "ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only");
                        update_button.attr("value", "更新");
                        update_button.attr("onclick", "save(this); return false;");
                        control_cell.append(update_button);
                    } else {
                        // 更新ボタン
                        var insert_button = createInput("button", "ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only");
                        insert_button.attr("type", "button");
                        insert_button.attr("value", "登録");
                        insert_button.attr("class", "ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only");
                        insert_button.attr("onclick", "save(this); return false;");
                        control_cell.append(insert_button);
                    }
                    row.append(control_cell);

                    $(".list > table").append(row);
                }
            },
            error: function(request, status) {
                console.log(request);
                console.log(status);
                var message = $("#message");
            },
            complete: function(request, status) {
                if (dialog == null) {
                    loading.dialog("close");
                }
            }
		});
	});
    $(".list table tr.detail").focus(function() {
		$(this).addClass("active");
	});
	$(".list table tr.detail").click(function() {
		$(this).addClass("active");
	});
	
    $(".list table tr.detail").blur(function() {
		$(this).removeClass("active");
    });
    dialog = $("<div>Loaging...</div>").dialog({
        modal: true,
        draggable: false,
        resizable: false,
        title: "Information",
        closeOnEscape: false
    });

    $.getJSON("/worktime/", {}, function(data, status, xhr) {
        dialog.dialog("close");
        $(".search input[name=from]").val(data.from);
        $(".search input[name=to]").val(data.to);
        $("#search_button").click();
    });
});

  </script>

  <div id="message">
  </div>

<div id="contents">
<div class="ui-widget ui-corner-all search">
	<form>
		<input type="text" class="date_chooser" name="from">-<input type="text" class="date_chooser" name="to">
		<input type="button" value="検索" id="search_button" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only">
	</form>
</div>
<br/>
<div class="ui-widget ui-corner-all list">
	<table summary="">
		<tr class="header">
			<th>日付</th>
			<th>開始</th>
			<th>終了</th>
			<th>コード</th>
			<th>内容</th>
			<th>備考</th>
			<th>操作</th>
		</tr>
	</table>
</div>
</div>
</body>
</html>
